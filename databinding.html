<html>
<head>
    <style type="text/css">
        html, body { height: 100%; overflow: auto; }
        body { padding: 0; margin: 0; }
        #silverlightControlHost { height: 100%; text-align: center; }
    </style>
    <script type="text/javascript">
        window.DLR = {path: "bin3"}
    </script>
    <script src="bin3/dlr.js" type="text/javascript"></script>
    <script type="text/python" src="repl.py" class="xaml" defer="true"></script>
    <script type="text/python" src="clrtype.py" class="xaml" defer="true"></script>
    <script type="text/python" src="pyevent.py" class="xaml" defer="true"></script>
    <title>databinding</title>
</head>
<body>
    <script type="application/xml+xaml" id="xaml" width="100%" height="25" defer="true">
        <UserControl xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                     xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
            <StackPanel x:Name="DataPanel" Orientation="Horizontal">
                <TextBlock Text="Size" />
                <TextBlock Text="{Binding size}" />
                <TextBox x:Name="tbSize" Text="{Binding size, Mode=TwoWay}" />
                <Button x:Name="Button" Content="Set Initial Value" />
            </StackPanel>
        </UserControl>
    </script>


    <script type="text/python" class="xaml">
        import clrtype
        import pyevent
        from System.Windows import Application
        from System.Windows.Controls import UserControl
        from System.ComponentModel import INotifyPropertyChanged, PropertyChangedEventArgs

        import sys
        import repl
        repl.show()

        class NotifyPropertyChangedBase(INotifyPropertyChanged):
            PropertyChanged = None

            def __init__(self):
                self.PropertyChanged, self._propertyChangedCaller = pyevent.make_event()

            def add_PropertyChanged(self, value):
                self.PropertyChanged += value

            def remove_PropertyChanged(self, value):
                self.PropertyChanged -= value

            def OnPropertyChanged(self, propertyName):
                if self.PropertyChanged is not None:
                    self._propertyChangedCaller(self, PropertyChangedEventArgs(propertyName))

        class notify_property(property):

            def __init__(self, getter):
                def newgetter(slf):
                    #return None when the property does not exist yet
                    try:
                        return getter(slf)
                    except AttributeError:
                        return None
                getter = clrtype.accepts()(getter)
                clrtype.propagate_attributes(getter, newgetter)
                super(notify_property, self).__init__(newgetter)

            def setter(self, setter):
                def newsetter(slf, newvalue):
                    # do not change value if the new value is the same
                    # trigger PropertyChanged event when value changes
                    oldvalue = self.fget(slf)
                    if oldvalue != newvalue:
                        setter(slf, newvalue)
                        slf.OnPropertyChanged(setter.__name__)
                setter = clrtype.returns()(setter)
                clrtype.propagate_attributes(setter, newsetter)
                return property(
                    fget=self.fget,
                    fset=newsetter,
                    fdel=self.fdel,
                    doc=self.__doc__)

        class ViewModel(NotifyPropertyChangedBase):
            __metaclass__ = clrtype.ClrClass
            _clrnamespace = "BindTest"
            
            def __init__(self):
                super(ViewModel, self).__init__()
                # must be string to two-way binding work correctly
                self.size = '10'

            @notify_property
            @clrtype.returns(str)
            def size(self):
                return self._size

            @size.setter
            @clrtype.accepts(str)
            def size(self, value):
                self._size = value
                print 'Size changed to %r' % self.size

        _vm = ViewModel()

        def OnClick(*a):
            # must be string to two-way binding work correctly
            _vm.size = '10'

        root = Application.Current.LoadRootVisualFromString(
                   document.xaml.innerHTML)
        root.DataPanel.DataContext = _vm
        root.Button.Click += OnClick
    </script>
</body>
</html>
